<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ | Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø±Ù‚ âš¡</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
        :root {
            --primary: #0062ff;
            --primary-light: #eef4ff;
            --secondary: #ff7b00;
            --success: #25d366;
            --danger: #ff3b30;
            --dark: #0f172a;
            --gray-light: #f8fafc;
            --glass: rgba(255, 255, 255, 0.9);
            --shadow-custom: 0 20px 50px rgba(0, 0, 0, 0.05);
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø¬Ø³Ù… */
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Ø§Ù„Ø£Ù†Ù…ÙŠØ´Ù† ÙˆØ§Ù„ØªØ­Ø±ÙƒØ§Øª */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fadeIn { animation: slideUp 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .glass-header {
            background: var(--glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 20px rgba(0,0,0,0.02);
        }

        .premium-card {
            background: white;
            border-radius: 35px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: var(--shadow-custom);
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .premium-card:hover { transform: translateY(-5px); box-shadow: 0 30px 60px rgba(0,0,0,0.08); }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
        #map {
            height: 350px;
            width: 100%;
            border-radius: 25px;
            z-index: 10;
            border: 5px solid white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .input-group label {
            display: block;
            margin-bottom: 8px;
            margin-right: 12px;
            font-size: 0.85rem;
            font-weight: 800;
            color: #64748b;
        }

        .fancy-input {
            width: 100%;
            padding: 18px 25px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 22px;
            font-weight: 700;
            transition: all 0.3s ease;
            outline: none;
        }

        .fancy-input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(0, 98, 255, 0.05);
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„ÙˆÙ‚Øª */
        .pay-card {
            cursor: pointer;
            border: 2px solid #f1f5f9;
            border-radius: 25px;
            padding: 20px;
            transition: all 0.3s ease;
            background: #f8fafc;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pay-radio:checked + .pay-card {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: scale(1.02);
        }

        /* ØªØµÙ…ÙŠÙ… Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ù„Ø© */
        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #ffffff;
            border-radius: 25px;
            margin-bottom: 12px;
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }

        .cart-item:hover { background: #fafafa; border-color: var(--primary-light); }

        .cart-item img {
            width: 65px;
            height: 65px;
            border-radius: 18px;
            object-fit: cover;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* Ø²Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ */
        .btn-confirm {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 22px;
            border-radius: 25px;
            font-weight: 900;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            box-shadow: 0 15px 35px rgba(37, 211, 102, 0.3);
            transition: all 0.4s ease;
        }

        .btn-confirm:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 45px rgba(37, 211, 102, 0.4);
        }
    </style>
</head>
<body class="pb-20">

    <header class="fixed top-0 left-0 right-0 z-[1000] glass-header px-6 py-4">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <button onclick="history.back()" class="w-12 h-12 rounded-2xl bg-white border border-slate-100 flex items-center justify-center text-slate-600 shadow-sm active:scale-90 transition-all">
                <i class="fas fa-chevron-right"></i>
            </button>
            <div class="text-center">
                <h1 class="text-xl font-black italic tracking-tighter">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ âš¡</h1>
                <p class="text-[9px] text-blue-600 font-bold uppercase tracking-widest">Al-Barq Fast Delivery</p>
            </div>
            <div class="w-12 h-12 rounded-2xl bg-blue-50 flex items-center justify-center text-blue-600 font-black relative">
                <i class="fas fa-shopping-bag"></i>
                <span id="floating-count" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center border-2 border-white">0</span>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 mt-28 grid grid-cols-1 lg:grid-cols-12 gap-10">
        
        <div class="lg:col-span-7 space-y-8">
            
            <section class="premium-card p-8 animate-fadeIn" style="animation-delay: 0.1s;">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-black flex items-center gap-3">
                        <span class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center"><i class="fas fa-receipt text-sm"></i></span>
                        Ù…Ø­ØªÙˆÙŠØ§Øª Ø³Ù„ØªÙƒ
                    </h2>
                    <span id="items-total-label" class="bg-slate-100 text-slate-500 px-4 py-1.5 rounded-full text-[10px] font-black italic">0 Ø£ØµÙ†Ø§Ù</span>
                </div>
                <div id="cart-container" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
            </section>

            <section class="premium-card p-8 animate-fadeIn" style="animation-delay: 0.2s;">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-black flex items-center gap-3">
                        <span class="w-10 h-10 bg-red-100 text-red-500 rounded-xl flex items-center justify-center"><i class="fas fa-map-pin text-sm"></i></span>
                        ÙˆØ¬Ù‡Ø© Ø§Ù„ØªÙˆØµÙŠÙ„
                    </h2>
                    <button onclick="gpsFetch()" class="text-[11px] font-black text-blue-600 bg-blue-50 px-5 py-2.5 rounded-xl hover:bg-blue-600 hover:text-white transition-all shadow-sm">
                        <i class="fas fa-location-crosshairs ml-1"></i> Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="input-group">
                        <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
                        <input type="tel" id="user-phone" placeholder="Ù…Ø«Ø§Ù„: 77" class="fancy-input">
                    </div>
                    <div class="input-group">
                        <label>ÙˆØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø¯Ù‚Ø©</label>
                        <input type="text" id="user-address" placeholder="Ø§Ù„Ø­ÙŠ - Ø§Ù„Ø´Ø§Ø±Ø¹ - Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„" class="fancy-input">
                    </div>
                </div>

                <div class="relative">
                    <div id="map"></div>
                    <div class="absolute bottom-5 left-5 right-5 z-[500]">
                        <div class="bg-black/80 backdrop-blur-md p-3 rounded-2xl border border-white/10 text-center">
                            <p class="text-[10px] text-white/80 font-bold italic italic">Ù‚Ù… Ø¨ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ Ù„ÙˆØ¶Ø¹Ù‡Ø§ ÙÙˆÙ‚ Ù…Ù†Ø²Ù„Ùƒ Ø¨Ø§Ù„Ø¶Ø¨Ø·</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="premium-card p-8 animate-fadeIn" style="animation-delay: 0.25s;">
                <h2 class="text-xl font-black mb-8 flex items-center gap-3">
                    <span class="w-10 h-10 bg-orange-100 text-orange-600 rounded-xl flex items-center justify-center"><i class="fas fa-clock text-sm"></i></span>
                    ÙˆÙ‚Øª Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 mb-6">
                    <label class="block">
                        <input type="radio" name="delivery_time_type" value="Ø§Ù„Ø¢Ù† (Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª)" class="peer hidden pay-radio" checked onchange="toggleTimePicker(false)">
                        <div class="pay-card peer-checked:border-blue-500">
                            <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-sm text-gray-400 peer-checked:text-blue-600">
                                <i class="fas fa-bolt text-xl"></i>
                            </div>
                            <div>
                                <p class="font-black text-sm">Ø§Ù„Ø¢Ù†</p>
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">As soon as possible</p>
                            </div>
                        </div>
                    </label>

                    <label class="block">
                        <input type="radio" name="delivery_time_type" value="ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯" class="peer hidden pay-radio" onchange="toggleTimePicker(true)">
                        <div class="pay-card peer-checked:border-blue-500">
                            <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-sm text-gray-400 peer-checked:text-blue-600">
                                <i class="fas fa-calendar-check text-xl"></i>
                            </div>
                            <div>
                                <p class="font-black text-sm">ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª</p>
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">Schedule delivery</p>
                            </div>
                        </div>
                    </label>
                </div>

                <div id="time-picker-container" class="hidden animate-fadeIn">
                    <div class="input-group">
                        <label>Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ùƒ</label>
                        <select id="scheduled-time" class="fancy-input bg-white">
                            <optgroup label="Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©">
                                <option value="08:00 Øµ">08:00 ØµØ¨Ø§Ø­Ø§Ù‹</option>
                                <option value="09:00 Øµ">09:00 ØµØ¨Ø§Ø­Ø§Ù‹</option>
                                <option value="10:00 Øµ">10:00 ØµØ¨Ø§Ø­Ø§Ù‹</option>
                                <option value="11:00 Øµ">11:00 ØµØ¨Ø§Ø­Ø§Ù‹</option>
                            </optgroup>
                            
                            <optgroup label="Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ©">
                                <option value="12:00 Ù…" selected>12:00 Ù…Ø³Ø§Ø¡Ù‹ (Ø¸Ù‡Ø±Ø§Ù‹)</option>
                                <option value="01:00 Ù…">01:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                                <option value="02:00 Ù…">02:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                                <option value="03:00 Ù…">03:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                                <option value="04:00 Ù…">04:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                                <option value="05:00 Ù…">05:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                                <option value="06:00 Ù…">06:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                                <option value="07:00 Ù…">07:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                                <option value="08:00 Ù…">08:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                                <option value="09:00 Ù…">09:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                                <option value="10:00 Ù…">10:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                                <option value="11:00 Ù…">11:00 Ù…Ø³Ø§Ø¡Ù‹</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
            </section>

            <section class="premium-card p-8 animate-fadeIn" style="animation-delay: 0.3s;">
                <h2 class="text-xl font-black mb-8 flex items-center gap-3">
                    <span class="w-10 h-10 bg-green-100 text-green-600 rounded-xl flex items-center justify-center"><i class="fas fa-wallet text-sm"></i></span>
                    ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ÙØ¶Ù„Ø©
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <label class="block">
                        <input type="radio" name="payment" value="ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…" class="peer hidden pay-radio" checked>
                        <div class="pay-card peer-checked:border-blue-500">
                            <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-sm text-gray-400 peer-checked:text-blue-600">
                                <i class="fas fa-hand-holding-dollar text-xl"></i>
                            </div>
                            <div>
                                <p class="font-black text-sm">Ù†Ù‚Ø¯Ù‹Ø§ (ÙƒØ§Ø´)</p>
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">Cash on delivery</p>
                            </div>
                        </div>
                    </label>

                    <label class="block">
                        <input type="radio" name="payment" value="ØªØ­ÙˆÙŠÙ„ Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©" class="peer hidden pay-radio">
                        <div class="pay-card peer-checked:border-blue-500">
                            <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-sm text-gray-400 peer-checked:text-blue-600">
                                <i class="fas fa-mobile-screen-button text-xl"></i>
                            </div>
                            <div>
                                <p class="font-black text-sm">Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</p>
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">E-Wallet Transfer</p>
                            </div>
                        </div>
                    </label>
                </div>
            </section>
        </div>

        <div class="lg:col-span-5">
            <div class="sticky top-28 space-y-8">
                <div class="premium-card bg-slate-900 text-white p-10 relative overflow-hidden animate-fadeIn" style="animation-delay: 0.4s;">
                    <div class="absolute -top-20 -right-20 w-64 h-64 bg-blue-600/10 rounded-full blur-3xl"></div>
                    
                    <h3 class="text-2xl font-black italic mb-10 border-b border-white/5 pb-6 flex justify-between items-center">
                        ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨
                        <i class="fas fa-bolt-lightning text-yellow-400"></i>
                    </h3>

                    <div class="space-y-6 mb-12">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400 font-bold">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</span>
                            <span id="summary-subtotal" class="font-black text-xl text-white tracking-tighter">0 Ø±.ÙŠ</span>
                        </div>
                        <div class="flex justify-between items-start pt-6 border-t border-white/5">
                            <div>
                                <span class="text-slate-400 font-bold block">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</span>
                                <span id="dist-info" class="text-[10px] text-blue-400 font-black italic">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</span>
                            </div>
                            <span id="summary-delivery" class="font-black text-xl text-blue-400 tracking-tighter">0 Ø±.ÙŠ</span>
                        </div>
                    </div>

                    <div class="bg-white/5 p-8 rounded-[35px] border border-white/5 mb-10">
                        <span class="text-slate-500 text-xs block font-black mb-2 uppercase tracking-widest">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</span>
                        <div class="flex justify-between items-end">
                            <span class="text-5xl font-black text-yellow-400 tracking-tighter" id="summary-total">0</span>
                            <span class="text-sm font-bold text-slate-400 mb-1 mr-2">Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ</span>
                        </div>
                    </div>

                    <button onclick="sendOrderToWhatsApp()" class="btn-confirm group">
                        <i class="fab fa-whatsapp text-3xl transition-transform group-hover:rotate-12"></i>
                        <span>ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>
                    </button>
                </div>

                <button onclick="clearCart()" class="w-full py-4 text-[11px] font-black text-slate-400 hover:text-red-500 transition-all uppercase tracking-widest">
                    <i class="fas fa-trash-can ml-2"></i> Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø³Ù„Ø©
                </button>
            </div>
        </div>
    </main>

    <script>
        const BARQ_CONFIG = {
            whatsappNumber: "967775185889",
            storeCoords: { lat: 15.3502, lng: 44.2075 },
            pricing: {
                base: 350, midRate: 300, longRate: 250, superRate: 200
            }
        };

        let appState = {
            cart: [], subtotal: 0, deliveryFee: 0, totalDistance: 0, map: null, userMarker: null
        };

        window.addEventListener('DOMContentLoaded', () => {
            initializeCart();
            setupMap();
        });

        // ÙˆØ¸ÙŠÙØ© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª
        function toggleTimePicker(show) {
            const container = document.getElementById('time-picker-container');
            if(show) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function initializeCart() {
            const savedCart = localStorage.getItem('barq_cart');
            appState.cart = savedCart ? JSON.parse(savedCart) : [];
            renderCartItems();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-container');
            const countBadge = document.getElementById('floating-count');
            const totalLabel = document.getElementById('items-total-label');
            appState.subtotal = 0;

            if (appState.cart.length === 0) {
                container.innerHTML = `<div class="text-center py-16"><p class="text-slate-400 font-black italic">Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ© Ø§Ù„Ø¢Ù†..</p></div>`;
                updateFinalDisplay();
                return;
            }

            countBadge.innerText = appState.cart.length;
            totalLabel.innerText = `${appState.cart.length} Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ø³Ù„Ø©`;

            container.innerHTML = appState.cart.map((item, index) => {
                const itemTotal = (Number(item.price) || 0) * (Number(item.quantity) || 0);
                appState.subtotal += itemTotal;
                return `
                <div class="cart-item group">
                    <img src="${item.img || 'https://via.placeholder.com/100'}" alt="${item.name}">
                    <div class="mr-4 flex-1">
                        <h4 class="font-black text-sm text-slate-800">${item.name}</h4>
                        <p class="text-[10px] font-bold text-blue-500 uppercase">${item.restaurantName || 'Ù…Ø·Ø¹Ù… Ø§Ù„Ø¨Ø±Ù‚'}</p>
                    </div>
                    <div class="text-left">
                        <p class="font-black text-sm text-slate-900">${itemTotal.toLocaleString()} <span class="text-[9px]">Ø±.ÙŠ</span></p>
                        <div class="flex items-center gap-3 mt-1">
                            <span class="text-[10px] text-slate-400 font-bold italic">Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity}</span>
                            <button onclick="removeItem(${index})" class="text-red-300 hover:text-red-500 transition-colors"><i class="fas fa-times-circle"></i></button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            updateFinalDisplay();
        }

        function removeItem(index) {
            appState.cart.splice(index, 1);
            localStorage.setItem('barq_cart', JSON.stringify(appState.cart));
            renderCartItems();
        }

        function clearCart() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) {
                localStorage.removeItem('barq_cart');
                location.reload();
            }
        }

        function setupMap() {
            const defaultPos = [BARQ_CONFIG.storeCoords.lat, BARQ_CONFIG.storeCoords.lng];
            appState.map = L.map('map', { zoomControl: false, attributionControl: false }).setView(defaultPos, 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(appState.map);
            appState.userMarker = L.marker(defaultPos, { draggable: true }).addTo(appState.map);
            appState.userMarker.on('dragend', (e) => calculateDeliveryFee(e.target.getLatLng()));
            setTimeout(() => appState.map.invalidateSize(), 500);
        }

        function calculateDeliveryFee(latlng) {
    const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
    const dLat = (latlng.lat - BARQ_CONFIG.storeCoords.lat) * Math.PI / 180;
    const dLon = (latlng.lng - BARQ_CONFIG.storeCoords.lng) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
              Math.cos(BARQ_CONFIG.storeCoords.lat * Math.PI / 180) * Math.cos(latlng.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    
    const distance = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    appState.totalDistance = distance;

    let finalFee = 0;
    let rateText = "";

    // ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:
    if (distance <= 1) { 
        // Ø£Ù‚Ù„ Ù…Ù† 1 ÙƒÙ… = 400 Ø±ÙŠØ§Ù„ (Ø³Ø¹Ø± Ø«Ø§Ø¨Øª)
        finalFee = 400; 
        rateText = "Ø³Ø¹Ø± Ø«Ø§Ø¨Øª";
    } 
    else if (distance <= 2.99) { 
        // Ù…Ù† 1 Ø¥Ù„Ù‰ 2 ÙƒÙ… (Ø£Ù‚Ù„ Ù…Ù† 3 ÙƒÙ…) = 300 Ø±ÙŠØ§Ù„ Ù„Ù„ÙƒÙŠÙ„Ùˆ
        finalFee = distance * 300; 
        rateText = "300 Ø±.ÙŠ / ÙƒÙ…";
    } 
    else if (distance <= 5) { 
        // Ù…Ù† 3 Ø¥Ù„Ù‰ 5 ÙƒÙ… = 250 Ø±ÙŠØ§Ù„ Ù„Ù„ÙƒÙŠÙ„Ùˆ
        finalFee = distance * 250; 
        rateText = "250 Ø±.ÙŠ / ÙƒÙ…";
    } 
    else { 
        // Ø£ÙƒØ«Ø± Ù…Ù† 5 ÙƒÙ… = 180 Ø±ÙŠØ§Ù„ Ù„Ù„ÙƒÙŠÙ„Ùˆ
        finalFee = distance * 180; 
        rateText = "180 Ø±.ÙŠ / ÙƒÙ…";
    }

    // ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø³Ø¹Ø± Ù„Ø£Ù‚Ø±Ø¨ 50 Ø±ÙŠØ§Ù„ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„ÙŠÙ…Ù†
    appState.deliveryFee = Math.ceil(finalFee / 50) * 50;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const distInfoElement = document.getElementById('dist-info');
    if (distInfoElement) {
        distInfoElement.innerText = `Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distance.toFixed(2)} ÙƒÙ… | ${rateText}`;
    }
    
    updateFinalDisplay();
}

        function gpsFetch() {
            if (!navigator.geolocation) return alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù€ GPS");
            navigator.geolocation.getCurrentPosition(p => {
                const pos = [p.coords.latitude, p.coords.longitude];
                appState.map.setView(pos, 18);
                appState.userMarker.setLatLng(pos);
                calculateDeliveryFee({lat: pos[0], lng: pos[1]});
            }, () => alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹"));
        }

        function updateFinalDisplay() {
            document.getElementById('summary-subtotal').innerText = `${appState.subtotal.toLocaleString()} Ø±.ÙŠ`;
            document.getElementById('summary-delivery').innerText = `${appState.deliveryFee.toLocaleString()} Ø±.ÙŠ`;
            document.getElementById('summary-total').innerText = (appState.subtotal + appState.deliveryFee).toLocaleString();
        }

        function sendOrderToWhatsApp() {
            const phone = document.getElementById('user-phone').value.trim();
            const address = document.getElementById('user-address').value.trim();
            const payMethod = document.querySelector('input[name="payment"]:checked').value;
            
            // Ø¬Ù„Ø¨ ÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±
            const timeType = document.querySelector('input[name="delivery_time_type"]:checked').value;
            const scheduledTime = document.getElementById('scheduled-time').value;
            const finalDeliveryTime = (timeType === "ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯") ? scheduledTime : timeType;

            if (appState.cart.length === 0 || !phone || !address || appState.deliveryFee === 0) {
                return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ");
            }

            const markerPos = appState.userMarker.getLatLng();
            const mapLink = `https://www.google.com/maps?q=${markerPos.lat},${markerPos.lng}`;
            const restaurants = [...new Set(appState.cart.map(i => i.restaurantName || "Ø§Ù„Ø¨Ø±Ù‚"))].join(' Ùˆ ');

            let msg = `*âš¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø±Ù‚ âš¡*\n`;
            msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            msg += `ğŸ¢ *Ø§Ù„Ù…Ø·Ø¹Ù…:* ${restaurants}\n`;
            msg += `ğŸ‘¤ *Ø§Ù„Ø¹Ù…ÙŠÙ„:* ${phone}\n`;
            msg += `ğŸ  *Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${address}\n`;
            msg += `ğŸ•’ *ÙˆÙ‚Øª Ø§Ù„ØªÙˆØµÙŠÙ„:* ${finalDeliveryTime}\n`; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙ‚Øª Ù‡Ù†Ø§
            msg += `ğŸ’³ *Ø§Ù„Ø¯ÙØ¹:* ${payMethod}\n`;
            msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            msg += `ğŸ›’ *Ø§Ù„Ø·Ù„Ø¨Ø§Øª:*\n`;
            appState.cart.forEach((item, i) => {
                msg += `${i+1}. ${item.name} (Ã—${item.quantity})\n   â”” Ø§Ù„Ø³Ø¹Ø±: ${(item.price * item.quantity).toLocaleString()} Ø±.ÙŠ\n`;
            });
            msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            msg += `ğŸ“ *Ø§Ù„Ù…Ø³Ø§ÙØ©:* ${appState.totalDistance.toFixed(2)} ÙƒÙ…\n`;
            msg += `ğŸ’° *Ø§Ù„ÙˆØ¬Ø¨Ø§Øª:* ${appState.subtotal.toLocaleString()} Ø±.ÙŠ\n`;
            msg += `ğŸšš *ØªÙˆØµÙŠÙ„:* ${appState.deliveryFee.toLocaleString()} Ø±.ÙŠ\n`;
            msg += `âœ… *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:* ${(appState.subtotal + appState.deliveryFee).toLocaleString()} Ø±.ÙŠ\n`;
            msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            msg += `ğŸ“ *Ø§Ù„Ù…ÙˆÙ‚Ø¹:*\n${mapLink}`;

            window.open(`https://wa.me/${BARQ_CONFIG.whatsappNumber}?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>